# 독립적인 나만의 가상 네트워크 공간 만들기

---

## Network

<br />

- Network : 서로가 가지고 있는 정보를 결합하여 생산적인 가치를 만드는 일
- 네트워킹한다 = 통신한다
- 서로 통신하기 위해 지켜야 하는 약속 = 프로토콜(protocol)

---

## VPN(Virtual Private Network)

<br />

- VPN : Virtual Private Network의 약자로 큰 규모의 조직이 여러 곳에 분산되어 있는 컴퓨터들을 연결하는 보안성이 높은 사설 네트워크를 만들거나 인터넷을 활용하여 원격지 간에 네트워크를 서로 연결하고 암호화 기술을 적용하여 보다 안정적이며 보안성 높은 통신 서비스를 제공하느 서비스를 말한다.

- 기존 IDC(Internet Data Center)에서 서비스하던 모든 시스템을 클라우드로 이전하는 것은 매우 어려운 일
  - 이러한 경우 IDC-클라우드 간의 네트워크 연결을 통해 기존 시스템과 클라우드 시스템 간의 데이터 통신이 필요하게 된다.
  - AWS는 VPC와 VPC Gateway를 통해 On-Premise의 VPN장비와 AWS 간의 VPN을 연결할 수 있으며 이를 통해 보안성 높은 하이브리드 클라우드 환경을 구현하여 원활한 클라우드 컴퓨팅 서비스를 지원한다.


---
## On-Premise 란?

<span align="center">

![](./images/%EC%98%A8%ED%94%84%EB%A0%88%EB%AF%B8%EC%8A%A4%EB%9E%80.png)

</span>

---
## VPC(Virtual Private Cloud)

- Amazon VPC는 Virtual Private Cloud 의 약자로 AWS 클라우드에서 논리적으로 격리된 네트워크 공간을 할당하여 가상 네트워크에서 AWS리소스를 이용할 수 있는 서비스를 제공
- Amazon VPC 자체 IP 주소 범위, 서브넷 생성, 라우팅 테이블 및 네트워크 게이트웨이 구성 선택 등 가상 네트워킹 환경을 완벽하게 제어할 수 있으며, VPC에서 IPv4와 IPv6를 모두 사용하여 리소스와 애플리케이션에 안전하고 쉽게 액세스 할 수 있다.
- 이러한 네트워크의 구성을 손쉽게 정의할 수 있으며, 보안 그룹 및 네트워크 제어목록을 포함한 다중 보안 계층을 활용하여 각 서브넷에서 EC2 인스턴스에 대한 액세스를 제어할 수 있다.
- 기업의 데이터 센터와 VPC 사이에 하드웨어 가상 사설 네트워크 연결을 생성하여 AWS 클라우드를 기업의 데이터 센터를 확장할 것처럼 사용할 수 있다.

---

## VPC 구성요소

- Private IP : 인터넷을 통해 연결할 수 없는, VPC 내부에서만 사용할 수 있는 IP

<br />

- Public IP : 인터넷을 통해 연결할 수 있는 IP 주소로, 인스턴스와 인터넷 간의 통신을 위해 사용할 수 있다.

<br />

- Elastic IP(탄력 주소) : 동적 컴퓨팅을 위해 고안된 고정 Public IP 주소이다. VPC의 모든 인스턴스와 네트워크 인터페이스에 탄성 IP를 할당할 수 있으며 다른 인스턴스에 주소를 신속하게 다시 매칭하여 인스턴스 장애 조치를 수행할 수도 있다.

<br />

#### VPC와 서브넷(Subnet)

- VPC는 사용자의 AWS 계정을 위한 전용의 가상 네트워크를 말한다.
- VPC는 AWS 클라우드에서 다른 가상 네트워크와 논리적으로 분리되어 있으며 EC2 인스턴스와 같은 AWS 리소스를 VPC에서 실행할 수 있다.
- VPC 내부의 네트워크에서도 서비스 목적에 따라 IP Block 으로 나누어 구분할 수 있다. 
  - 이렇게 분리된 IP Block을 서브넷 이라고 한다.

- VPC는 리전의 모든 가용영역에 적용되며 각 가용영역에 하나이상의 서브넷을 추가할 수 있다. 하지만 서브넷은 단일 가용영역에서만 생성할 수 있으며 여러 가용영역으로 확장할 수 없다.

<br />

#### VPC와 서브넷의 사이즈

- VPC를 생성할 때 VPC에서 사용하게 될 IP 주소의 범위를 지정하게 뙤는데 범위를 CIDR 블록 형태로 지정해야 한다.
- VPC를 생성하는 경우 10.0.0.0/24 로 VPC를 생성하게 되면 256개의 IP주소를 지원하게 되며, CIDR 블록을 각각 128개의 IP주소를 지원하는 2개의 서브넷으로 나눌 수 있다. 
  - 한 서브넷은 10.0.0.0/25(0 ~ 127) 과 다른 서브넷은 10.0.0.128/25(128 ~ 255)을 사용하도록 구성할 수 있다는 말이다.

<br />

#### 퍼블릭 서브넷과 프라이빗 서브넷

- 서브넷 네트워크 트래픽이 인터넷 게이트웨이로 라우팅이 되는 서브넷을 퍼블릭 서브넷이라 하고, 인터넷 게이트웨이로 라우팅되지 않는 서브넷을 프라이빗 서브넷이라 한다.
- EC2 인스턴스가 IP를 통해 인터넷과 통신을 할 수 있게 하려면 퍼블릭 IP주소나 탄력 IP주소가 있어야한다. 일반적으로 인터넷망을 통해 서비스를 수행하는 웹서버는 퍼블릭 서브넷에 생성하며 인터넷에 직접적으로 연결할 필요하고 없고 보다 높은 보안성을 필요로하는 DB 서버는 프라이빗 서브넷에 생성한다. 

<br />

#### 라우팅 테이블 

- 각 서브넷은 서브넷 외부로 나가는 아웃바운드 트래픽에 대해 허용된 경로를 지정하는 라우팅 테이블이 연결되어 있어야 한다. 
- 생성된 서브넷은 자동으로 VPC의 기본 라우팅 테이블과 연결되며 테이블의 내용을 변경할 수 있다. 
- 이러한 라우팅 테이블은 VPC의 서브넷 내에서 생성된 네트워크 패킷이 목적지 주소로 이용하기 위해 어떤 경로로 이동되어야 하는지를 알려주는 나침반과 비슷한 개념으로 이해하면 된다. 
- 따라서 서브넷 간의 통신이나 VPC간의 원활한 통신을 위해 라우팅 테이블을 이용한다.

---

## VPC의 주요 서비스 

<br />

#### 보안 그룹과 네트워크 액세스 제어 목록

- VPC는 네트워크 통신과 트래픽에 대해 IP와 Port를 기준으로 통신을 허용하거나 차단하기 위한 기능을 제공
- 이러한 서비스를 보안 그룹과 네트워크 액세스 제어 목록이라 함
- VPC의 보안 그룹과 네트워크 ACL을 통해 AWS 상에서 방화벽과 동일한 기능을 사용할 수 있다. 

|구분|보안그룹|네트워크 ACL|
|:--:|:--|:--|
|서비스 범위|인스턴스 레벨에 적용|서브넷 레벨에 적용|
|적용 정책|허용 규칙만 적용|허용 및 거부 규칙 적용|
|구동 방식|규칙에 상관 없이 반환 트래픽 허용|반환 트래픽이 별도로 허용되어야 함|
|룰 검토/적용|해당 객체 내 모든 룰 검토|해당 객체 내 룰을 번호 순으로 처리|
|적용 방법|인스턴스에 보안 그룹 추가 필요|연결된 서브넷에 모든 인스턴스 자동 적용됨|

- 이와 같은 차이로 인해 필요에 따라 선택적인 사용을 권장함

<br />

#### VPC 피어링 연결

- 피어링 연결은 비공개적으로 두 VPC 간에 트래픽을 라우팅할 수 있게 하기 위한 서로 다른 VPC간의 네트워크 연결을 제공한다. 
- VPC Peering 을 통해 동일한 네트워크에 속한 것과 같이 서로 다른 VPC의 인스턴스간에 통신이 가능하다.

<br />

#### NAT(Network Address Translation) 게이트웨이

- 외부 네트워크에 알려진 것과 다른 IP주소를 사용하는 내부 네트워크에서 내부 IP주소를 외부 IP주소로 변환하는 작업을 수행하는 서비스이다. 
- NAT게이트웨이는 프라이빗 서브넷 내에 있는 인스턴스를 인터넷 또는 다른 AWS 서비스에 연결하고 외부망 또는 인터넷에서 해당 인스턴스에 연결하지 못하도록 구성하는데 사용한다. 
- 외부에 공개될 필요가 없거나 보안상 중요한 서비스이지만 윈도우 패치나 보안 업데이트, 소프트웨어 업데이트를 인터넷을 통해 받아야하는 경우 NAT 게이트웨이나 NAT인스턴스를 사용하게 된다. 

- NAT 게이트웨이를 구성하기 위해 다음 세가지 조건을 만족해야 한다. 
  - NAT 게이트를 생성하기 위해 퍼블릭 서브넷을 지정
  - NAT 게이트웨이와 연결할 탄력적 IP 주소 필요
  - NAT 게이트웨이를 만든 후 인터넷 트래픽이 NAT 게이트웨이로 통신이 가능하도록 프라이빗 서브넷과 연결된 라우팅 테이블 업데이트 

- 이처럼 NAT 게이트웨이를 구성하면 프라이빗 서브넷의 인스턴스가 인터넷과 통신할 수 있다.

<br />

#### VPC Endpoint

- Amazon S3는 인터넷망에 연결된 서비스로 인터넷 기반의 IP 주소와 연결 정보를 가지고 있다.
- 이러한 공용 리소스에 대해 퍼블릭 서브넷에 위치한 인스턴스는 인터넷을 통해 문제없이 연결 가능하다.하지만 프라이빗 서브넷에 위치한 인스턴스는 인터넷과 연결되어 있는 S3와 같은 공용 리소스를 연결할 수 없다.
- 이러한 경우 S3에 연결하기 위해서는 NAT 게이트웨이나 NAT인스턴스가 필요하다. 하지만 VPC Endpoint를 이용하면 빠르고 손쉽게 S3, Dynamo DB에 연결할 수 있다.

<br />

#### VPN(Virtual Private Network) 연결

- 기본적으로 Amazon VPC에서 서비스되는 인스턴스는 On-Premise에 있는 서버나 IDC내의 시스템과 통신할 수 없다. 
- 물론 인터넷을 통해 강제로 통신하도록 구성할 수 있지만, 보안을 필요로 하는 중요한 데이터를 송수신하기에는 보안적으로 매우 취약하다
- 이렇게 AWS VPC 내 인스턴스와 IDC 내 시스템간의 데이터 통신을 위해 VPC에 가상의 프라이빗 게이트웨이를 연결하고 사용자 지정 라우팅 테이블을 생서하며, 보안 그룹의 규칙을 업데이트 하고, AWS 관리형 VPN 연결을 생성하여 VPC에서 원격의 네트워크 접속 가능하도록 하이브리드 클라우드 환경을 구성할 수 있다. 
- VPN 연결은 VPC와 자체 네트워크 사이의 연결을 의미한다.